# 运动员43批量处理脚本使用说明

## 功能描述

这个脚本用于批量处理运动员ID为43的所有活动，对每个活动调用 `/all` 接口，使用 Strava access_token 获取完整数据。

## 文件说明

- `batch_process_athlete_43.py` - 主处理脚本
- `batch_config.py` - 配置文件
- `batch_process_athlete_43.log` - 运行日志文件（自动生成）

## 使用方法

### 1. 配置数据库连接

首先修改 `batch_config.py` 文件中的数据库连接信息：

```python
DB_CONFIG = {
    "host": "localhost",
    "port": 3306,
    "user": "root",
    "password": "your_password",  # 修改为实际密码
    "database": "fit_api_db"
}
```

### 2. 运行脚本

#### 处理所有活动
```bash
python batch_process_athlete_43.py
```

#### 测试单个活动
```bash
python batch_process_athlete_43.py test 106
```

#### 显示帮助
```bash
python batch_process_athlete_43.py help
```

## 配置选项

在 `batch_config.py` 中可以调整以下参数：

- `delay_seconds`: 每次请求间隔时间（秒），避免API限流
- `timeout_seconds`: 请求超时时间（秒）
- `max_activities`: 最大处理活动数，None表示处理所有
- `athlete_id`: 目标运动员ID（当前为43）

## 功能特性

1. **自动查询**: 从数据库查询运动员43的所有活动
2. **批量处理**: 逐个调用 `/all` 接口处理每个活动
3. **错误处理**: 完善的异常处理和重试机制
4. **进度显示**: 实时显示处理进度和状态
5. **日志记录**: 详细的操作日志，保存到文件
6. **统计信息**: 处理完成后显示详细统计

## 输出示例

```
2024-01-15 10:30:00 - INFO - 开始处理运动员 43 的所有活动...
2024-01-15 10:30:01 - INFO - 找到 25 个活动
2024-01-15 10:30:01 - INFO - 进度: 1/25 - 处理活动 12345
2024-01-15 10:30:01 - INFO - 正在处理活动 12345: 晨骑训练
2024-01-15 10:30:05 - INFO - ✅ 活动 12345 处理成功
2024-01-15 10:30:05 - INFO - 等待 1.0 秒...
...
2024-01-15 10:35:00 - INFO - ============================================================
2024-01-15 10:35:00 - INFO - 处理完成！统计信息:
2024-01-15 10:35:00 - INFO - 运动员ID: 43
2024-01-15 10:35:00 - INFO - 总活动数: 25
2024-01-15 10:35:00 - INFO - 成功处理: 24
2024-01-15 10:35:00 - INFO - 处理失败: 1
2024-01-15 10:35:00 - INFO - 跳过处理: 0
2024-01-15 10:35:00 - INFO - 总耗时: 300.00 秒
2024-01-15 10:35:00 - INFO - 平均每个活动: 12.00 秒
```

## 注意事项

1. **API限流**: 脚本已设置1秒间隔，避免触发Strava API限流
2. **网络稳定**: 确保网络连接稳定，避免请求失败
3. **数据库权限**: 确保数据库用户有查询 `tb_activity` 表的权限
4. **服务器状态**: 确保API服务器正在运行
5. **中断恢复**: 可以使用 Ctrl+C 中断处理，会显示当前统计信息

## 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查 `batch_config.py` 中的数据库配置
   - 确认数据库服务正在运行
   - 验证用户名密码是否正确

2. **API请求失败**
   - 检查API服务器是否正在运行
   - 验证 access_token 是否有效
   - 查看网络连接是否正常

3. **权限错误**
   - 确保数据库用户有相应表的查询权限
   - 检查文件写入权限（日志文件）

### 调试方法

1. 使用测试模式先处理单个活动：
   ```bash
   python batch_process_athlete_43.py test 106
   ```

2. 查看详细日志：
   ```bash
   tail -f batch_process_athlete_43.log
   ```

3. 检查数据库中的活动数据：
   ```sql
   SELECT COUNT(*) FROM tb_activity WHERE athlete_id = 43;
   ```
